<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            background-color: black;
        }
        
        @keyframes animate1 {
            0% {
                color: white;
            }
            100% {
                color: blue;
            }
        }
        
        @keyframes animate2 {
            0% {
                color: white;
            }
            100% {
                color: red;
            }
        }
    </style>
</head>

<body>
    <div class="fixed text-white text-6xl font-bold w-full text-center select-none mt-40" id="levelEl">Level <span id="rankLevelEl">0</span></div>
    <div class="fixed text-white ml-2 mt-1 select-none"><span>Score: </span><span id="scoreEL">0</span></div>
    <div class="fixed inset-0 flex items-center justify-center" id="modalEl">
        <div class="bg-white max-w-md w-full p-6 text-center">
            <h1 class="text-4xl font-bold leading-none" id="bigScoreEl">0</h1>
            <p class="text-sm text-gray-700 mb-4">Points</p>
            <div>
                <button class="bg-blue-500 text-white w-full py-3 rounded-full" id="startGameEl">Start Game</button>
            </div>
        </div>
    </div>
    <canvas></canvas>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.5.1/gsap.min.js" integrity="sha512-IQLehpLoVS4fNzl7IfH8Iowfm5+RiMGtHykgZJl9AWMgqx0AmJ6cRWcB+GaGVtIsnC4voMfm8f2vwtY+6oPjpQ==" crossorigin="anonymous"></script>
    <script>
        const canvas = document.querySelector('canvas');
        canvas.width = innerWidth;
        canvas.height = innerHeight;
        const c = canvas.getContext('2d');
        const scoreEL = document.querySelector("#scoreEL");
        const StartGameBtn = document.querySelector("#startGameEl");
        const modalEl = document.querySelector("#modalEl");
        const bigScoreEl = document.querySelector("#bigScoreEl");
        const levelEl = document.querySelector("#levelEl");
        const rankLevelEl = document.querySelector("#rankLevelEl");
        levelEl.style.display = 'none';
        const friction = 0.99;
        const x = canvas.width / 2;
        const y = canvas.height / 2;
        let score = 0;
        let animationId;
        let spawnEneyId;


        class Player {
            constructor(x, y, radius, color) {
                this.x = x;
                this.y = y;
                this.radius = radius;
                this.color = color;
            }
            draw() {
                c.beginPath();
                c.arc(this.x, this.y, this.radius, 0, Math.PI * 2, false);
                c.fillStyle = this.color;
                c.fill();
            }
        }
        class Projectile {
            constructor(x, y, radius, color, velocity) {
                this.x = x;
                this.y = y;
                this.radius = radius;
                this.color = color;
                this.velocity = velocity;
            }
            draw() {
                c.beginPath();
                c.arc(this.x, this.y, this.radius, 0, Math.PI * 2, false);
                c.fillStyle = this.color;
                c.fill();
            }
            update() {
                this.draw();
                this.x = this.x + this.velocity.x;
                this.y = this.y + this.velocity.y;
            }
        }
        class Enemy {
            constructor(x, y, radius, color, velocity) {
                this.x = x;
                this.y = y;
                this.radius = radius;
                this.color = color;
                this.velocity = velocity;
            }
            draw() {
                c.beginPath();
                c.arc(this.x, this.y, this.radius, 0, Math.PI * 2, false);
                c.fillStyle = this.color;
                c.fill();
            }

            update() {
                this.draw();
                this.x = this.x + this.velocity.x;
                this.y = this.y + this.velocity.y;
            }
        }
        class Particle {
            constructor(x, y, radius, color, velocity) {
                this.x = x;
                this.y = y;
                this.radius = radius;
                this.color = color;
                this.velocity = velocity;
                this.alpha = 1;
            }
            draw() {
                c.save();
                c.globalAlpha = this.alpha;
                c.beginPath();
                c.arc(this.x, this.y, this.radius, 0, Math.PI * 2, false);
                c.fillStyle = this.color;
                c.fill();
                c.restore();
            }

            update() {
                this.draw();
                this.velocity.x *= friction;
                this.velocity.y *= friction;

                this.x = this.x + this.velocity.x;
                this.y = this.y + this.velocity.y;
                this.alpha -= 0.01;
            }
        }
        let projectiles = [];
        let enemies = [];
        let particles = [];

        function init() {
            player = new Player(x, y, 20, 'white');
            projectiles = [];
            enemies = [];
            particles = [];
            score = 0;
            bigScoreEl.innerHTML = score;
            scoreEL.innerHTML = score;

        }

        function spawnEnemies(timeRenderEnemy, speed) {
            console.log(timeRenderEnemy);
            let amountEnemy = 0;

            spawnEneyId = setInterval(() => {
                amountEnemy++;
                if (amountEnemy == 20) {
                    clearInterval(spawnEneyId);
                }
                const radius = Math.random() * 40 + 20;
                let x;
                let y;
                if (Math.random() < 0.5) {
                    x = Math.random() < 0.5 ? 0 - radius : canvas.width + radius;
                    y = Math.random() * canvas.height
                } else {
                    y = Math.random() < 0.5 ? 0 - radius : canvas.height + radius;
                    x = Math.random() * canvas.width
                }
                const color = `hsl(${Math.random() * 360}, 50% , 50% )`;
                const angel = Math.atan2(canvas.height / 2 - y, canvas.width / 2 - x);
                const velocity = {
                    x: Math.cos(angel) * speed,
                    y: Math.sin(angel) * speed
                }
                enemies.push(new Enemy(x, y, radius, color, velocity));
                console.log(amountEnemy);
            }, timeRenderEnemy)
        }

        let timeRound = 0;
        let timeRenderEnemy = 1000;
        let speed = 1;
        let level = 0;
        let colorPlayer = "white";

        function animate() {
            animationId = requestAnimationFrame(animate);
            c.fillStyle = 'rgba(0,0,0,0.1)';
            c.fillRect(0, 0, canvas.width, canvas.height);
            player.draw();
            console.log(timeRenderEnemy);
            particles.forEach((particle, index) => {
                if (particle.alpha <= 0)
                    particles.splice(index, 1);
                else
                    particle.update();
            })
            projectiles.forEach((projectile, index) => {
                projectile.update();
                if (projectile.x + projectile.radius < 0 ||
                    projectile.x - projectile.radius > canvas.width ||
                    projectile.y + projectile.radius < 0 ||
                    projectile.y - projectile.radius > canvas.height) {
                    setTimeout(() => {
                        projectiles.splice(index, 1);
                    }, 0)
                }
            })
            if (timeRound == 20) {
                if (timeRenderEnemy > 200) {
                    timeRenderEnemy -= 100;
                }
                if (level > 9 && speed < 8) {
                    speed += 0.3;
                    colorPlayer = "red";
                    levelEl.style.display = 'block';
                    levelEl.style.animation = "animate2 4s";
                } else {
                    levelEl.style.display = 'block';
                    levelEl.style.animation = "animate1 4s";
                }
                setTimeout(() => {
                    spawnEnemies(timeRenderEnemy, speed);
                    levelEl.style.display = 'none';
                }, 4000)
                level++;
                rankLevelEl.innerHTML = level;

                timeRound = 0;

            }
            console.log(timeRound);
            enemies.forEach((enemy, index) => {

                enemy.update();
                //end game
                const distan = Math.hypot(player.x - enemy.x, player.y - enemy.y);
                if (distan - player.radius - enemy.radius < 1) {
                    cancelAnimationFrame(animationId);
                    clearInterval(spawnEneyId);
                    modalEl.style.display = 'flex';
                    bigScoreEl.innerHTML = score;
                }
                //when projectile touch enemy
                projectiles.forEach((projectile, projectileIndex) => {
                    const distan = Math.hypot(projectile.x - enemy.x, projectile.y - enemy.y);
                    if (distan - projectile.radius - enemy.radius < 1) {
                        for (let i = 0; i < 50; i++) {
                            particles.push(new Particle(projectile.x, projectile.y, Math.random() * 3, enemy.color, {
                                x: (Math.random() - 0.5) * (Math.random() * 6),
                                y: (Math.random() - 0.5) * (Math.random() * 6)
                            }))
                        }
                        if (enemy.radius - 20 > 20) {
                            score += 100;
                            scoreEL.innerHTML = score;
                            gsap.to(enemy, {
                                radius: enemy.radius - 10
                            })
                            setTimeout(() => {
                                projectiles.splice(projectileIndex, 1);
                            }, 0);

                        } else {
                            timeRound++;
                            score += 200;
                            scoreEL.innerHTML = score;
                            setTimeout(() => {
                                projectiles.splice(projectileIndex, 1);
                                enemies.splice(index, 1);
                            }, 0);
                        }

                    }
                })
            })
        }

        addEventListener('click', (event) => {
            const angel = Math.atan2(event.clientY - canvas.height / 2, event.clientX - canvas.width / 2);
            const velocity = {
                x: Math.cos(angel) * (speed * 5),
                y: Math.sin(angel) * (speed * 5)
            }
            projectiles.push(new Projectile(canvas.width / 2, canvas.height / 2, 5, colorPlayer, velocity));

        })
        StartGameBtn.addEventListener('click', () => {
            modalEl.style.display = 'none';
            init();
            animate();
            spawnEnemies(timeRenderEnemy, speed);
            // timeEnd();

        })
    </script>
</body>

</html>